<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Zac McChesney | Admin</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto Mono', monospace;
    }
  </style>
</head>
<body>
<script>
  const username = prompt('Username:')
  const password = prompt('Password:')
</script>
<h1>Zac McChesney Admin</h1>
<ul id="posts"></ul>
<button id="new-post">New post</button>
<hr>
<div id="content"></div>

<script>
  const getPosts = () => fetch('/posts')
    .then(req => req.json())

  const addPost = ({ title, content, author }) => fetch('/post', {
    method: 'POST',
    headers: {
      'content-type': 'application/json',
      authorization: `Basic ${ btoa(`${ username }:${ password }`) }`
    },
    body: JSON.stringify({ title, content, author })
  })

  const updatePost = ({ title, content, author }) => fetch('/post', {
    method: 'PUT',
    headers: {
      'content-type': 'application/json',
      authorization: `Basic ${ btoa(`${ username }:${ password }`) }`
    },
    body: JSON.stringify({ title, content, author })
  })

  const removePost = title => fetch(`/post?title=${ title }`, {
    method: 'DELETE',
    headers: {
      authorization: `Basic ${ btoa(`${ username }:${ password }`) }`
    }
  })

  const createPostEditor = post => {
    const holder = document.createElement('div')
    holder.innerHTML = `<button id="remove" style="display: ${ post ? 'block' : 'none' }">Remove</button>
                        Title: <div contenteditable="true" id="title" style="min-width: 50px; min-height: 10px">${ post ? post.title : '' }</div>
                        Author: <div contenteditable="true" id="author" style="min-width: 50px; min-height: 10px">${ post ? post.author : '' }</div>
                        Content: <div contenteditable="true" id="post-content" style="min-width: 50px; min-height: 10px">${ post ? post.content : '' }</div>
                        <button id="submit">Save</button>`
    holder.querySelector('#remove').addEventListener('click', () => {
      removePost(post.title)
    })
    holder.querySelector('#submit').addEventListener('click', () => {
      (post ? updatePost : addPost)({
        title: holder.querySelector('#title').innerHTML,
        author: holder.querySelector('#author').innerHTML,
        content: holder.querySelector('#post-content').innerHTML
      })
    })

    return holder
  }

  document.getElementById('new-post').addEventListener('click', () => {
    const content = document.getElementById('content')
    for (const child of content.children) {
      child.remove()
    }
    content.appendChild(createPostEditor())
  })

  const drawPosts = posts => {
    const postsList = document.getElementById('posts')
    const content = document.getElementById('content')

    for (const child of postsList.children) {
      child.remove()
    }

    for (const post of posts) {
      const li = document.createElement('li')
      li.innerHTML = `<a href="#">${ post.title }</a>`
      li.firstElementChild.addEventListener('click', () => {
        for (const child of content.children) {
          child.remove()
        }
        content.appendChild(createPostEditor(post))
      })
      postsList.appendChild(li)
    }
  }

  getPosts().then(drawPosts)
</script>
</body>
</html>
